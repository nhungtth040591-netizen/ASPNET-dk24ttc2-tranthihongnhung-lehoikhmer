@model KhmerFestival.Web.Models.ViewModels.ArticleListViewModel

@{
    ViewData["Title"] = "Bài viết";
}

<h1 class="display-5 mb-4 text-center">Bài viết về lễ hội Khmer</h1>

<div class="row mb-4">
    <!-- Filter theo Category -->
    <div class="col-md-12 d-flex justify-content-end">
        <div class="form-inline">
            <select class="form-control form-control-sm mr-2"
                    style="min-width: 180px;"
                    name="categoryId"
                    form="articleFilterForm"
                    onchange="document.getElementById('articleFilterForm').submit();">
            <option value="">Tất cả chủ đề</option>
            @if (Model.Categories != null)
            {
                foreach (var c in Model.Categories)
                {
                    <option value="@c.CategoryId"
                            selected="@(Model.CategoryId == c.CategoryId)">
                        @c.Name
                    </option>
                }
            }
            </select>
        

            <!-- Filter theo Festival -->
            <select class="form-control form-control-sm"
                    style="min-width: 200px;"
                    name="festivalId"
                    form="articleFilterForm"
                    onchange="document.getElementById('articleFilterForm').submit();">
                <option value="">Tất cả lễ hội</option>
                @if (Model.Festivals != null)
                {
                    foreach (var f in Model.Festivals)
                    {
                        <option value="@f.FestivalId"
                                selected="@(Model.FestivalId == f.FestivalId)">
                            @f.Name
                        </option>
                    }
                }
            </select>
        </div>
    </div>
</div>

<form id="articleFilterForm" method="get" asp-action="Index" asp-controller="Article">
    <!-- q vẫn giữ để nếu user search ở header thì filter không làm mất từ khóa -->
    <input type="hidden" name="q" value="@Model.Search" />
</form>

@if (!string.IsNullOrWhiteSpace(Model.Search))
{
    <p class="text-muted">
        Kết quả cho: <strong>@Model.Search</strong>
        (@Model.TotalItems bài viết)
    </p>
}

<div class="row">
    @if (Model.Articles == null || !Model.Articles.Any())
    {
        <div class="col-12">
            <p>Chưa có bài viết nào.</p>
        </div>
    }
    else
    {
        foreach (var a in Model.Articles)
        {
            <div class="col-md-4 mb-4">
                <div class="card h-100 border-0 shadow-sm hover-shadow">
                    @if (!string.IsNullOrEmpty(a.ThumbnailUrl))
                    {
                        <img src="@a.ThumbnailUrl" class="card-img-top" alt="@a.Title" />
                    }
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">@a.Title</h5>
                        <p class="card-text text-muted small mb-2">
                            <i class="fas fa-calendar-alt mr-1"></i>
                            @(a.PublishedDate?.ToString("dd/MM/yyyy") ?? a.CreatedAtUtc.ToString("dd/MM/yyyy"))
                            @if (a.Category != null)
                            {
                                @($" • {a.Category.Name}")
                            }
                        </p>

                        @if (!string.IsNullOrEmpty(a.Summary))
                        {
                            <p class="card-text text-muted small">
                                @(a.Summary.Length > 140 ? a.Summary.Substring(0, 140) + "..." : a.Summary)
                            </p>
                        }

                        <div class="mt-auto">
                            <a asp-controller="Article"
                               asp-action="Detail"
                               asp-route-slug="@a.Slug"
                               class="btn btn-sm btn-outline-primary">
                                Đọc tiếp
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@if (Model.TotalPages > 1)
{
    <nav aria-label="Phân trang bài viết" class="mt-3">
        <ul class="pagination justify-content-center">
            <li class="page-item @(Model.PageNumber == 1 ? "disabled" : "")">
                <a class="page-link"
                   href="@Url.Action("Index", new { page = Model.PageNumber - 1, q = Model.Search, categoryId = Model.CategoryId, festivalId = Model.FestivalId })"
                   aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>

            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                    <a class="page-link"
                       href="@Url.Action("Index", new { page = i, q = Model.Search, categoryId = Model.CategoryId, festivalId = Model.FestivalId })">
                        @i
                    </a>
                </li>
            }

            <li class="page-item @(Model.PageNumber == Model.TotalPages ? "disabled" : "")">
                <a class="page-link"
                   href="@Url.Action("Index", new { page = Model.PageNumber + 1, q = Model.Search, categoryId = Model.CategoryId, festivalId = Model.FestivalId })"
                   aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
}
